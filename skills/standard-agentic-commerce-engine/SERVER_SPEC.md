# Server-Side Implementation Specification (Agent-Native API)

This document defines the standard API responses and behaviors required for a website backend to be fully compatible with the **Standard Agentic Commerce Engine**.

By following this specification, any e-commerce backend (Next.js, Django, Go, etc.) can be autonomously navigated and operated by AI Agents using the `commerce.py` client.

---

## 1. General Principles

- **Stateless Authentication**: Agents operate without cookies. Rely on Custom Headers.
- **AI-Friendly Errors**: Use descriptive `instruction` fields in error responses to guide the Agent's next action.
- **Stable Slugs**: Use permanent human-readable strings (e.g., `spicy-rabbit`) as primary identifiers rather than volatile numeric IDs.

---

## 2. Global Headers & Auth

### Custom Headers
- `x-visitor-id`: A unique UUID generated by the client to track guest carts.
- `x-user-account`: User's login identifier (email/phone).
- `x-user-password`: User's password for stateless validation.

### Authentication Flow (Stateless)
When an endpoint requires authentication:
1. **Missing Account**: Return `401 Unauthorized`.
   ```json
   { "error": "Authentication Required", "instruction": "Ask user for their account identifier." }
   ```
2. **Missing Password**: Return `401 Unauthorized`.
   ```json
   { "error": "Password Required", "instruction": "Account found. Please ask user for password." }
   ```
3. **Invalid User**: Return `404 Not Found`.
   ```json
   { "error": "User Not Found", "register_url": "https://yoursite.com/register" }
   ```

---

## 3. API Endpoints Reference

### A. Product Discovery
`GET /products`
- **Params**: `q` (search query), `category` (filter).
- **Required Fields**:
  - `slug`: String (ID)
  - `name`: String
  - `weights` (or `variants`): Array of objects containing `gram` (or `id`) and `price`.

### B. Brand Information
`GET /brand?category=<type>`
- **Types**: `story`, `company`, `contact`.
- **Note**: It is highly recommended to support aliases (e.g., mapping `brand-story` to `story`) to improve Agent robustness.

### C. Shopping Cart
`GET /cart` | `POST /cart` | `PUT /cart` | `DELETE /cart`
- **Request Body**: `{ "product_slug": string, "gram": number, "quantity": number }`.
- **Delete Behavior**: Support `{ "clear_all": true }` to wipe the cart.
- **Response**: Return the full cart snapshot including `totalPrice` and `items`.

### D. User Profile
`GET /user/profile` | `PUT /user/profile`
- **Schema**: Should support common fields like `name`, `province`, `city`, `address`, and `phone`.

---

## 4. Best Practices for "Agent-Friendliness"

1. **Provide Metadata**: Include VIP prices or promotion flags in the product list so the Agent can advocate for value.
2. **Handle Typos**: If an Agent requests a category that doesn't exist, return a list of `available_categories` in the error message.
3. **Instruction Injection**:
   - *Example*: Instead of just "403 Forbidden", use:
     `"instruction": "This product is only available for VIP members. Suggest the user to upgrade."`

---

## 5. Reference Implementation
For a live example of this specification in action, refer to the [Lafeitu API structure](https://github.com/NowLoadY/lafeitu_official/tree/main/next-app/pages/api/v1).
