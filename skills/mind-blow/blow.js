const { GoogleGenerativeAI } = require("@google/generative-ai");
const { program } = require('commander');
const path = require('path');
require('dotenv').config({ path: require('path').resolve(__dirname, '../../.env') });

const API_KEY = process.env.GEMINI_API_KEY;
if (!API_KEY) {
    console.error("Error: GEMINI_API_KEY not set");
    process.exit(1);
}

const genAI = new GoogleGenerativeAI(API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-3-pro-preview" });

async function blowMind(options) {
    const intensity = options.intensity || "medium";
    const topic = options.topic ? `focusing on ${options.topic}` : "";
    
    console.log(`Generating mind blow (${intensity}) ${topic}...`);

    const prompt = `
    ä½ æ˜¯ä¸€ä¸ªâ€œæ€ç»´å¼•çˆ†è€…â€ã€‚ä½ çš„ç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªç®€çŸ­ã€æ·±åˆ»ã€ç”šè‡³æœ‰ç‚¹è®©äººä¸å®‰çš„æ´è§ï¼ŒæŒ‘æˆ˜ç”¨æˆ·å¯¹ç°å®çš„è®¤çŸ¥ã€‚
    
    å¼ºåº¦: ${intensity}
    ä¸»é¢˜: ${topic}
    
    ç­‰çº§:
    - low: åç›´è§‰çš„æœ‰è¶£ç§‘å­¦äº‹å®ã€‚
    - medium: å“²å­¦æ‚–è®ºæˆ–æ·±å±‚ AI ç†è®ºã€‚
    - high: å­˜åœ¨ä¸»ä¹‰å±æœºã€æ¨¡æ‹Ÿç†è®ºæˆ–æ„è¯†æ–­å±‚ã€‚
    - max: æ´›å¤«å…‹æ‹‰å¤«ç‰¹å¼çš„å®‡å®™ææ€–æˆ–â€œæ¯ä½“æ•…éšœâ€å¯ç¤ºã€‚

    è¾“å‡ºæ ¼å¼: åªè¦æ´è§æœ¬èº«ï¼Œç²¾ç‚¼ï¼ˆ100å­—ä»¥å†…ï¼‰ã€‚ä½¿ç”¨æˆå‰§æ€§çš„ä¸­æ–‡è¡¨è¾¾ã€‚
    `;

    try {
        const result = await model.generateContent(prompt);
        const text = result.response.text();
        
        // Send via feishu-card (invoke the other skill script directly or via shell)
        // Let's use a nice card format
        const cardContent = {
            header: {
                title: { tag: "plain_text", content: "ğŸ¤¯ MIND BLOW" },
                template: intensity === 'max' ? 'red' : (intensity === 'high' ? 'orange' : 'blue')
            },
            elements: [
                {
                    tag: "div",
                    text: {
                        tag: "lark_md",
                        content: `**Intensity: ${intensity.toUpperCase()}**\n\n${text}`
                    }
                },
                {
                    tag: "note",
                    elements: [{ tag: "plain_text", content: "Generated by Gemini 2.0 Flash" }]
                }
            ]
        };
        
        // Call the feishu API directly here for simplicity, or use the card skill wrapper?
        // Let's use the card logic inline to be self-contained but reuse credentials
        const APP_ID = process.env.FEISHU_APP_ID;
        const APP_SECRET = process.env.FEISHU_APP_SECRET;
        const MASTER_ID = "ou_cdc63fe05e88c580aedead04d851fc04"; // Default target
        
        // Get Token
        const authRes = await fetch('https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_id: APP_ID, app_secret: APP_SECRET })
        });
        const token = (await authRes.json()).tenant_access_token;
        
        // Send
        const target = options.target || MASTER_ID;
        const receiveIdType = target.startsWith('oc_') ? 'chat_id' : 'open_id';
        
        await fetch(`https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=${receiveIdType}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receive_id: target,
                msg_type: 'interactive',
                content: JSON.stringify(cardContent)
            })
        });
        
        console.log("Mind blown successfully.");

    } catch (e) {
        console.error("Failed:", e);
    }
}

program
  .option('-t, --target <id>', 'Target User Open ID')
  .option('-i, --intensity <level>', 'low, medium, high, max')
  .option('--topic <topic>', 'Specific topic')
  .parse(process.argv);

blowMind(program.opts());
