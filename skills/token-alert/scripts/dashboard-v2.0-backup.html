<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time Clawdbot token usage monitoring with smart alerts">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Token Alert">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <title>Token Alert</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root[data-theme="light"] {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --progress-bg: #f0f0f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --header-text: #ffffff;
        }

        :root[data-theme="dark"] {
            --bg-gradient-start: #1e1e1e;
            --bg-gradient-end: #2d2d30;
            --card-bg: #252526;
            --text-primary: #cccccc;
            --text-secondary: #858585;
            --border-color: #3e3e42;
            --progress-bg: #3e3e42;
            --shadow: rgba(0, 0, 0, 0.6);
            --header-text: #cccccc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .dashboard {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 40px var(--shadow);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden; /* No horizontal scroll */
            animation: slideIn 0.5s ease-out;
            transition: background 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--header-text);
            padding: 18px 20px;
            text-align: center;
            position: relative;
            transition: background 0.3s ease;
        }

        .theme-toggle, .settings-btn {
            position: absolute;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle {
            right: 20px;
        }
        
        .settings-btn {
            left: 20px;
        }

        .theme-toggle:hover, .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            filter: brightness(1.15);
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle:active, .settings-btn:active {
            transform: translateY(0px);
            filter: brightness(0.95);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .emoji {
            font-size: 24px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .content {
            padding: 22px 20px 18px 20px; /* Extra top padding for floating buttons */
        }

        .provider-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: hidden; /* No horizontal scroll */
            padding: 4px 0 8px 0; /* Top padding for shadow/border */
            flex-wrap: wrap; /* Allow wrapping if needed */
        }

        .provider-tab {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            background: var(--progress-bg);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
            flex: 1; /* Equal width distribution */
            text-align: center;
        }

        .provider-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow);
            filter: brightness(1.15);
            background: var(--border-color);
        }

        .provider-tab:active {
            transform: translateY(0px);
            filter: brightness(0.95);
        }

        .provider-tab.active {
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: white;
            font-weight: 700;
            border: 1px solid rgba(192, 192, 192, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow), 
                        0 0 6px rgba(192, 192, 192, 0.2);
        }
        
        .provider-tab.active:hover {
            filter: brightness(1.15);
            box-shadow: 0 8px 16px var(--shadow), 
                        0 0 10px rgba(192, 192, 192, 0.4);
        }
        
        .provider-tab.active:active {
            transform: translateY(0px);
            filter: brightness(0.95);
        }
        
        .provider-tab.active::after {
            content: ' ‚úì';
            margin-left: 4px;
            font-size: 16px;
        }

        .provider-content {
            display: none;
        }

        .provider-content.active {
            display: block;
        }

        .usage-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: var(--progress-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-bar::after {
            content: attr(data-percent);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 12px;
            color: white;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 1;
        }
        
        :root[data-theme="light"] .progress-bar::after {
            color: #1a1a1a;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }

        .progress-fill.green, .session-progress-fill.green { 
            background: linear-gradient(90deg, #4CAF50, #66BB6A); 
        }
        .progress-fill.yellow, .session-progress-fill.yellow { 
            background: linear-gradient(90deg, #FFEB3B, #FFC107); 
        }
        .progress-fill.orange, .session-progress-fill.orange { 
            background: linear-gradient(90deg, #D89050, #C67C3E); 
        }
        .progress-fill.red-orange, .session-progress-fill.red-orange { 
            background: linear-gradient(90deg, #D86C50, #C65840); 
        }
        .progress-fill.red, .session-progress-fill.red { 
            background: linear-gradient(90deg, #D85050, #C04040); 
        }
        .progress-fill.magenta, .session-progress-fill.magenta { 
            background: linear-gradient(90deg, #C05070, #A84060); 
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            25%, 75% { opacity: 0.7; }
        }

        @keyframes alertPop {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes alertFadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
        }

        /* Custom slider styling with fill effect */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--progress-bg);
            outline: none;
            position: relative;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #b0b0b0;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #b0b0b0;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #c8c8c8;
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: #c8c8c8;
            transform: scale(1.1);
        }

        /* Firefox range progress - inverted (fills from right) */
        input[type="range"]::-moz-range-track {
            background: linear-gradient(270deg, var(--bg-gradient-start), var(--bg-gradient-end));
            height: 6px;
            border-radius: 3px;
        }
        
        input[type="range"]::-moz-range-progress {
            background: var(--progress-bg);
            height: 6px;
            border-radius: 3px;
        }

        .tokens-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .status-badge {
            display: block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin: 12px auto;
            text-align: center;
            width: fit-content;
        }

        .status-badge.ok { background: #4CAF50; color: white; }
        .status-badge.low { background: #FFEB3B; color: #333; }
        .status-badge.medium { background: #D89050; color: white; }
        .status-badge.high { background: #D86C50; color: white; }
        .status-badge.critical { background: #D85050; color: white; }
        .status-badge.emergency { background: #C05070; color: white; }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .detail-card {
            background: var(--progress-bg);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: background 0.3s ease;
        }

        .detail-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .detail-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: none; /* No uppercase */
            letter-spacing: 0.3px;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .recommendation {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 14px;
            border-radius: 8px;
            margin-top: 16px;
            color: #333;
        }

        :root[data-theme="dark"] .recommendation {
            background: #3e3e42;
            border-left-color: #FFEB3B;
            color: var(--text-primary);
        }

        .recommendation.warning {
            background: #f8d7da;
            border-left-color: #F44336;
        }

        :root[data-theme="dark"] .recommendation.warning {
            background: #3e3e42;
            border-left-color: #D86C50;
            color: var(--text-primary);
        }

        .recommendation.danger {
            background: #fce4ec;
            border-left-color: #E91E63;
        }

        :root[data-theme="dark"] .recommendation.danger {
            background: #3e3e42;
            border-left-color: #C05070;
            color: var(--text-primary);
        }

        .recommendation-title {
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .recommendation-list {
            list-style: none;
            padding-left: 20px;
            font-size: 12px;
        }

        .recommendation-list li {
            margin: 3px 0;
        }

        .recommendation-list li::before {
            content: "‚úÖ";
            margin-right: 6px;
        }

        .recommendation.warning li::before { content: "‚ö°"; }
        .recommendation.danger li::before { content: "üî¥"; }

        /* Multi-Session Tracking */
        .session-item {
            background: var(--progress-bg);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-item:hover {
            background: var(--border-color);
            transform: translateX(2px);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .session-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .session-percent {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .session-progress {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .session-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn {
            background: var(--progress-bg);
            color: var(--text-primary);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow);
            filter: brightness(1.15);
            background: var(--border-color);
        }

        .btn:active {
            transform: translateY(0px);
            filter: brightness(0.95);
        }

        /* Usage History Chart */
        .chart-section {
            margin: 24px 0;
            padding: 16px;
            background: var(--progress-bg);
            border-radius: 12px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-timeframe {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
        }

        .timeframe-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeframe-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: white;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 8px;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <span>‚öôÔ∏è</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <span id="themeIcon">üåô</span>
            </button>
            <h1>
                <span class="emoji" id="statusEmoji">üü¢</span>
                Token Alert
            </h1>
        </div>

        <div class="content">
            <!-- Single Provider: Anthropic Claude -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="display: inline-block; padding: 10px 20px; border-radius: 12px; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: white; font-weight: 700; font-size: 14px;">
                    ü§ñ Anthropic Claude
                </div>
            </div>

            <!-- Provider Contents -->
            <div id="provider-anthropic" class="provider-content active">
                <div class="usage-label">5-Hour Limit</div>
                <div class="progress-bar" id="progressBar" data-percent="0%">
                    <div class="progress-fill green" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="tokens-info">
                    <span id="usedTokens">0 tokens used</span>
                    <span id="totalTokens">/ 200,000</span>
                </div>
                <div class="tokens-info" style="margin-top: -8px;">
                    <span id="costEstimate" style="color: var(--text-secondary); font-size: 12px;">Cost: $0.00</span>
                    <span id="costLimit" style="color: var(--text-secondary); font-size: 12px;">/ ~$6.00</span>
                </div>

                <div class="usage-label" style="margin-top: 16px;">Weekly Limit</div>
                <div class="progress-bar" id="progressBarWeekly" data-percent="0%">
                    <div class="progress-fill green" id="progressFillWeekly" style="width: 0%"></div>
                </div>
                <div class="tokens-info">
                    <span id="usedTokensWeekly">0 tokens used</span>
                    <span id="totalTokensWeekly">/ ~1M</span>
                </div>
                <div class="tokens-info" style="margin-top: -8px;">
                    <span id="costEstimateWeekly" style="color: var(--text-secondary); font-size: 12px;">Cost: $0.00</span>
                    <span id="costLimitWeekly" style="color: var(--text-secondary); font-size: 12px;">/ ~$30.00</span>
                </div>

                <div class="status-badge ok" id="statusBadge">All good!</div>

                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-icon">üí°</div>
                        <div class="detail-label" id="remainingLabel">‚è± 5h left</div>
                        <div class="detail-value" id="remainingTokens">~200k</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">‚è∞</div>
                        <div class="detail-label">Sessions left</div>
                        <div class="detail-value" id="sessionEstimate">~3-4</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üîÆ</div>
                        <div class="detail-label">Time to 100%</div>
                        <div class="detail-value" id="predictionTime">Calculating...</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üìà</div>
                        <div class="detail-label">Model</div>
                        <div class="detail-value" id="modelName">Sonnet 4.5</div>
                    </div>
                </div>

                <!-- Usage History Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Usage History</h3>
                        <div class="chart-timeframe">
                            <button class="timeframe-btn active" onclick="setChartTimeframe('1h')">1h</button>
                            <button class="timeframe-btn" onclick="setChartTimeframe('6h')">6h</button>
                            <button class="timeframe-btn" onclick="setChartTimeframe('24h')">24h</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>

                <div id="recommendationBox"></div>

                <!-- Multi-Session Tracking -->
                <div class="sessions-section" id="sessionsSection" style="margin-top: 24px; display: none;">
                    <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                        üßµ Active Chat-Sessions
                    </h3>
                    <div id="sessionsList"></div>
                </div>

                <div class="actions">
                    <button class="btn" onclick="newSession()">
                        <span>üîÑ</span> New Chat
                    </button>
                    <button class="btn" onclick="summarize()">
                        <span>üìù</span> Summary
                    </button>
                    <button class="btn" onclick="exportMemory()">
                        <span>üíæ</span> Export
                    </button>
                </div>
            </div>

            <!-- Multi-provider support planned for future release -->
        </div>
    </div>

    <script>
        // Theme Management
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function getSavedTheme() {
            return localStorage.getItem('token-alert-theme') || 'auto';
        }

        function getEffectiveTheme() {
            const saved = getSavedTheme();
            if (saved === 'auto') {
                return getSystemTheme();
            }
            return saved;
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('themeIcon');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleTheme() {
            const current = getEffectiveTheme();
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('token-alert-theme', next);
            applyTheme(next);
        }

        // Initialize theme on load
        applyTheme(getEffectiveTheme());

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (getSavedTheme() === 'auto') {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // Provider switching
        // ==========================================
        // LIVE GATEWAY INTEGRATION
        // ==========================================
        
        const GATEWAY_URL = '/api'; // Proxy server routes /api/* to Gateway
        const GATEWAY_TOKEN = 'd91a7a91e0d6bda8b6e3182467fda1f0bebd34c830263a4f';
        const REFRESH_INTERVAL = 30000; // 30 seconds
        const USE_MOCK_DATA = false; // Real Gateway data (no mock)
        
        let currentSessionPercent = 40; // fallback (real: 60% left = 40% used)
        let weeklyPercent = 34; // fallback (real: 66% left = 34% used)
        
        // ==========================================
        // RESET TRACKING
        // ==========================================
        
        function loadHistory() {
            const history = localStorage.getItem('tokenHistory');
            return history ? JSON.parse(history) : {
                session5h: [],
                weekly: [],
                resets: []
            };
        }
        
        function saveHistory(history) {
            localStorage.setItem('tokenHistory', JSON.stringify(history));
        }
        
        function detectReset(currentValue, lastValue, type) {
            // Reset detected if current < last (usage went down)
            if (lastValue && currentValue < lastValue - 5) { // -5% threshold to avoid noise
                const reset = {
                    type: type, // '5h' or 'weekly'
                    timestamp: Date.now(),
                    before: lastValue,
                    after: currentValue
                };
                
                console.log(`üîÑ RESET DETECTED (${type}):`, reset);
                
                const history = loadHistory();
                history.resets.push(reset);
                
                // Keep last 100 resets
                if (history.resets.length > 100) {
                    history.resets = history.resets.slice(-100);
                }
                
                saveHistory(history);
                
                // Show notification
                showNotification(`üîÑ ${type === '5h' ? '5-Hour' : 'Weekly'} Reset detected!`, 'info');
                
                return true;
            }
            return false;
        }
        
        function recordUsage(session5h, weekly) {
            const history = loadHistory();
            const now = Date.now();
            
            // Get last values
            const lastSession = history.session5h.length > 0 
                ? history.session5h[history.session5h.length - 1].value 
                : null;
            const lastWeekly = history.weekly.length > 0 
                ? history.weekly[history.weekly.length - 1].value 
                : null;
            
            // Detect resets
            detectReset(session5h, lastSession, '5h');
            detectReset(weekly, lastWeekly, 'weekly');
            
            // Record new values
            history.session5h.push({ timestamp: now, value: session5h });
            history.weekly.push({ timestamp: now, value: weekly });
            
            // Keep last 1000 entries per type (~ 8h at 30s intervals)
            if (history.session5h.length > 1000) {
                history.session5h = history.session5h.slice(-1000);
            }
            if (history.weekly.length > 1000) {
                history.weekly = history.weekly.slice(-1000);
            }
            
            saveHistory(history);
        }
        
        function getRecentResets(hoursBack = 24) {
            const history = loadHistory();
            const cutoff = Date.now() - (hoursBack * 60 * 60 * 1000);
            return history.resets.filter(r => r.timestamp > cutoff);
        }
        
        // ==========================================
        // USAGE HISTORY CHART
        // ==========================================
        
        let usageChart = null;
        let chartTimeframe = '1h'; // Default 1 hour
        
        function initChart() {
            const ctx = document.getElementById('usageChart');
            if (!ctx) return;
            
            const isDark = getEffectiveTheme() === 'dark';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#cccccc' : '#1a1a1a';
            
            usageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '5h Limit',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Weekly Limit',
                            data: [],
                            borderColor: 'rgb(118, 75, 162)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: { size: 11, weight: '600' },
                                usePointStyle: true,
                                padding: 10
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(37, 37, 38, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                font: { size: 10 },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            updateChart();
        }
        
        function updateChart() {
            if (!usageChart) return;
            
            const history = loadHistory();
            const now = Date.now();
            
            // Determine time window based on selected timeframe
            let hoursBack = 1;
            if (chartTimeframe === '6h') hoursBack = 6;
            else if (chartTimeframe === '24h') hoursBack = 24;
            
            const cutoff = now - (hoursBack * 60 * 60 * 1000);
            
            // Filter data points within timeframe
            const session5hData = history.session5h.filter(d => d.timestamp > cutoff);
            const weeklyData = history.weekly.filter(d => d.timestamp > cutoff);
            
            // Generate labels (time points)
            const labels = [];
            const session5hValues = [];
            const weeklyValues = [];
            
            // Determine time interval for labels
            let interval = 5 * 60 * 1000; // 5 minutes default
            if (hoursBack >= 6) interval = 15 * 60 * 1000; // 15 min for 6h
            if (hoursBack >= 24) interval = 60 * 60 * 1000; // 1 hour for 24h
            
            // Group data points by interval
            const timeSlots = {};
            
            session5hData.forEach(point => {
                const slot = Math.floor(point.timestamp / interval) * interval;
                if (!timeSlots[slot]) timeSlots[slot] = { session5h: [], weekly: [] };
                timeSlots[slot].session5h.push(point.value);
            });
            
            weeklyData.forEach(point => {
                const slot = Math.floor(point.timestamp / interval) * interval;
                if (!timeSlots[slot]) timeSlots[slot] = { session5h: [], weekly: [] };
                timeSlots[slot].weekly.push(point.value);
            });
            
            // Convert to chart data
            const sortedSlots = Object.keys(timeSlots).sort((a, b) => a - b);
            
            sortedSlots.forEach(slot => {
                const slotData = timeSlots[slot];
                const time = new Date(parseInt(slot));
                
                // Format label based on timeframe
                let label;
                if (hoursBack === 1) {
                    label = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                } else if (hoursBack === 6) {
                    label = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                } else {
                    label = time.toLocaleString('de-DE', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit' 
                    });
                }
                
                labels.push(label);
                
                // Average values for the time slot
                const avg5h = slotData.session5h.length > 0
                    ? slotData.session5h.reduce((a, b) => a + b, 0) / slotData.session5h.length
                    : null;
                    
                const avgWeekly = slotData.weekly.length > 0
                    ? slotData.weekly.reduce((a, b) => a + b, 0) / slotData.weekly.length
                    : null;
                
                session5hValues.push(avg5h);
                weeklyValues.push(avgWeekly);
            });
            
            // Update chart
            usageChart.data.labels = labels;
            usageChart.data.datasets[0].data = session5hValues;
            usageChart.data.datasets[1].data = weeklyValues;
            usageChart.update('none'); // No animation for realtime updates
        }
        
        function setChartTimeframe(timeframe) {
            chartTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateChart();
        }
        
        // Initialize chart when DOM is ready
        if (typeof Chart !== 'undefined') {
            window.addEventListener('load', () => {
                initChart();
            });
        }
        
        async function fetchGatewayStats() {
            // Mock data for testing (until CORS is fixed)
            if (USE_MOCK_DATA) {
                console.log('üìä Using MOCK data (CORS bypass)');
                return { 
                    current: 40, // 60% left = 40% used
                    weekly: 34,  // 66% left = 34% used
                    timeLeft: '4h 14m' // Mock time
                };
            }
            
            try {
                const response = await fetch(`${GATEWAY_URL}/tools/invoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GATEWAY_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tool: 'session_status',
                        args: {}
                    })
                });
                
                if (!response.ok) {
                    console.error('Gateway API error:', response.status);
                    return null;
                }
                
                const data = await response.json();
                const statusText = data.result?.details?.statusText || '';
                
                console.log('üìä Raw Gateway Response:', statusText);
                
                // Parse: "üìä Usage: 5h 68% left ‚è±43m ¬∑ Week 67% left ‚è±5d 18h"
                // More flexible regex: catch any time format (5h, 12h, 1d etc.)
                const usageMatch = statusText.match(/Usage:\s*\S+\s*(\d+)%\s*left\s*‚è±([^\s¬∑]+).*Week\s*(\d+)%\s*left/);
                
                if (usageMatch) {
                    const fiveHourLeft = parseInt(usageMatch[1]);
                    const timeLeft = usageMatch[2]; // e.g. "4h14m" or "43m"
                    const weeklyLeft = parseInt(usageMatch[3]);
                    
                    currentSessionPercent = 100 - fiveHourLeft; // Convert "left" to "used"
                    weeklyPercent = 100 - weeklyLeft;
                    
                    console.log('‚úÖ Gateway Stats Parsed:', {
                        raw5h: fiveHourLeft + '% left',
                        timeLeft: timeLeft,
                        rawWeek: weeklyLeft + '% left',
                        current: currentSessionPercent + '% used',
                        weekly: weeklyPercent + '% used'
                    });
                    
                    return { 
                        current: currentSessionPercent, 
                        weekly: weeklyPercent,
                        timeLeft: timeLeft 
                    };
                } else {
                    console.error('‚ùå Failed to parse usage from:', statusText);
                }
                
                return null;
                
            } catch (error) {
                console.error('Failed to fetch gateway stats:', error);
                return null;
            }
        }
        
        // ==========================================
        // BROWSER NOTIFICATIONS
        // ==========================================
        
        let lastNotificationLevel = 0; // Track to avoid spam
        
        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        function showVisualAlert(percent, limitType = '5h') {
            if (!visualAlertsEnabled) return;
            
            // Determine alert level based on percent
            let level = 0;
            if (percent >= 95) level = 5;
            else if (percent >= 90) level = 4;
            else if (percent >= 75) level = 3;
            else if (percent >= 50) level = 2;
            else if (percent >= 25) level = 1;
            
            // Don't show duplicate alerts for same level
            if (level <= lastVisualAlertLevel && level < 4) {
                return;
            }
            
            lastVisualAlertLevel = level;
            
            // Determine alert style
            let emoji, title, message, bgColor;
            
            if (percent >= 95) {
                emoji = 'üö®';
                title = 'EMERGENCY!';
                message = `${percent}% used - START NEW SESSION NOW!`;
                bgColor = 'linear-gradient(135deg, #C05070, #A84060)';
            } else if (percent >= 90) {
                emoji = 'üî¥';
                title = 'CRITICAL!';
                message = `${percent}% used - Session almost full!`;
                bgColor = 'linear-gradient(135deg, #D85050, #C04040)';
            } else if (percent >= 75) {
                emoji = 'üî∂';
                title = 'High Warning';
                message = `${percent}% used - Prepare new session`;
                bgColor = 'linear-gradient(135deg, #D86C50, #C65840)';
            } else if (percent >= 50) {
                emoji = 'üü†';
                title = 'Medium Warning';
                message = `${percent}% used - ${limitType} limit`;
                bgColor = 'linear-gradient(135deg, #D89050, #C67C3E)';
            } else if (percent >= 25) {
                emoji = 'üü°';
                title = 'Low Warning';
                message = `${percent}% used - ${limitType} limit`;
                bgColor = 'linear-gradient(135deg, #FFEB3B, #FFC107)';
            }
            
            // Create visual alert overlay
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.8);
                background: ${bgColor};
                color: white;
                padding: 32px 48px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                z-index: 10000;
                text-align: center;
                animation: alertPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
                min-width: 320px;
                max-width: 90%;
            `;
            
            alert.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 16px;">${emoji}</div>
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">${title}</div>
                <div style="font-size: 16px; opacity: 0.95;">${message}</div>
            `;
            
            document.body.appendChild(alert);
            
            // Auto-remove after duration
            const duration = percent >= 90 ? 8000 : 4000;
            setTimeout(() => {
                alert.style.animation = 'alertFadeOut 0.3s ease-out forwards';
                setTimeout(() => alert.remove(), 300);
            }, duration);
            
            // Play sound if enabled
            if (soundEnabled) {
                if (percent >= 95) playAlertSound('emergency');
                else if (percent >= 90) playAlertSound('critical');
                else if (percent >= 75) playAlertSound('warning');
            }
        }
        
        function sendBrowserNotification(level, percent) {
            if (!notificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            // Don't spam - only notify when crossing new thresholds
            if (level <= lastNotificationLevel) {
                return;
            }
            
            lastNotificationLevel = level;
            
            let title, body, icon, requireInteraction;
            
            if (percent >= 95) {
                title = 'üö® TOKEN EMERGENCY!';
                body = `${percent}% used - START NEW SESSION NOW!`;
                icon = 'üö®';
                requireInteraction = true;
                playAlertSound('emergency');
            } else if (percent >= 90) {
                title = 'üî¥ CRITICAL Warning!';
                body = `${percent}% used - End session now!`;
                icon = 'üî¥';
                requireInteraction = true;
                playAlertSound('critical');
            } else if (percent >= 75) {
                title = 'üî∂ High Warning';
                body = `${percent}% used - Session almost full`;
                icon = 'üî∂';
                requireInteraction = false;
                playAlertSound('warning');
            }
            
            const notification = new Notification(title, {
                body: body,
                icon: icon,
                tag: 'token-alert', // Replace previous notifications
                requireInteraction: requireInteraction,
                silent: false
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
            
            // Auto-close after 10 seconds (except critical)
            if (!requireInteraction) {
                setTimeout(() => notification.close(), 10000);
            }
        }
        
        function playAlertSound(level) {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Resume AudioContext if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // macOS "Ping" style sound - single impulse with quick decay
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different frequencies based on urgency
                const frequencies = {
                    warning: 600,    // Lower pitch
                    critical: 750,   // Medium pitch
                    emergency: 900   // Higher pitch
                };
                
                oscillator.type = 'sine';
                oscillator.frequency.value = frequencies[level] || 750;
                
                const now = audioContext.currentTime;
                
                // macOS Ping envelope: instant attack, exponential decay
                gainNode.gain.setValueAtTime(soundVolume, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
                
                // For critical/emergency, play double ping
                if (level === 'critical' || level === 'emergency') {
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        
                        osc2.type = 'sine';
                        osc2.frequency.value = frequencies[level];
                        
                        const now2 = audioContext.currentTime;
                        gain2.gain.setValueAtTime(soundVolume * 0.8, now2);
                        gain2.gain.exponentialRampToValueAtTime(0.001, now2 + 0.3);
                        
                        osc2.start(now2);
                        osc2.stop(now2 + 0.3);
                    }, 200); // Second ping after 200ms
                }
                
                console.log('üîä Playing macOS-style ping:', level, 'volume:', soundVolume);
                
            } catch (error) {
                console.error('Audio playback error:', error);
            }
        }
        
        async function updateFromGateway() {
            const stats = await fetchGatewayStats();
            if (stats) {
                // Record usage & detect resets
                recordUsage(stats.current, stats.weekly);
                
                // Update chart with new data
                updateChart();
                
                updateDashboard(stats.current, stats.timeLeft, stats.weekly);
                
                // Check both limits and use worse case
                const worsePercent = Math.max(stats.current, stats.weekly || 0);
                const limitType = stats.weekly > stats.current ? 'Weekly' : '5h';
                
                // Trigger visual alerts at 25%, 50%, 75%, 90%, 95%
                if (worsePercent >= 25) {
                    showVisualAlert(worsePercent, limitType);
                }
                
                // Trigger browser notifications at 75%, 90%, 95%
                if (worsePercent >= 75) {
                    let level = 0;
                    if (worsePercent >= 95) level = 4;
                    else if (worsePercent >= 90) level = 3;
                    else if (worsePercent >= 75) level = 2;
                    
                    sendBrowserNotification(level, worsePercent);
                }
            } else {
                // Fallback to last known values
                updateDashboard(currentSessionPercent, null, weeklyPercent);
            }
        }
        
        // ==========================================
        // MULTI-SESSION TRACKING
        // ==========================================
        
        async function fetchSessions() {
            // Mock data for testing (if enabled)
            if (USE_MOCK_DATA) {
                return [
                    {
                        key: 'agent:main:main',
                        label: '', // Will show "Main Session (Web-Chat)"
                        channel: 'webchat',
                        totalTokens: 57000,
                        contextTokens: 1000000,
                        updatedAt: Date.now() - 300000 // 5 min ago
                    },
                    {
                        key: 'agent:main:main',
                        label: '', // Will show "Main Session (Telegram)"
                        channel: 'telegram',
                        totalTokens: 58000,
                        contextTokens: 1000000,
                        updatedAt: Date.now() - 600000 // 10 min ago
                    },
                    {
                        key: 'agent:main:subagent:dashboard-integration-research',
                        label: '', // Will show "Dashboard-integration-research"
                        channel: 'webchat',
                        totalTokens: 65000,
                        contextTokens: 1000000,
                        updatedAt: Date.now() - 180000 // 3 min ago
                    }
                ];
            }
            
            try {
                const response = await fetch(`${GATEWAY_URL}/tools/invoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GATEWAY_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tool: 'sessions_list',
                        args: { limit: 20 }
                    })
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                return data.result?.details?.sessions || [];
                
            } catch (error) {
                console.error('Failed to fetch sessions:', error);
                return null;
            }
        }
        
        function renderSessions(sessions) {
            const container = document.getElementById('sessionsList');
            const section = document.getElementById('sessionsSection');
            
            if (!sessions || sessions.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            // Filter out empty sessions
            const activeSessions = sessions.filter(s => s.totalTokens > 0 && s.contextTokens > 0);
            
            if (activeSessions.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            // Track duplicate names to add differentiators
            const nameCount = {};
            const nameIndex = {};
            
            // First pass: count duplicates
            activeSessions.forEach(session => {
                let baseName = session.label || '';
                
                if (!baseName) {
                    const keyParts = session.key.split(':');
                    const subagentIndex = keyParts.indexOf('subagent');
                    if (subagentIndex >= 0 && keyParts.length > subagentIndex + 1) {
                        baseName = keyParts[subagentIndex + 1];
                    } else if (keyParts.includes('main')) {
                        baseName = 'Main Session';
                    } else {
                        const lastPart = keyParts[keyParts.length - 1];
                        if (lastPart.length > 20 && lastPart.includes('-')) {
                            baseName = (session.channel || 'Unknown') + ' Chat';
                        } else {
                            baseName = lastPart;
                        }
                    }
                }
                
                baseName = baseName.charAt(0).toUpperCase() + baseName.slice(1);
                nameCount[baseName] = (nameCount[baseName] || 0) + 1;
                nameIndex[baseName] = 0;
            });
            
            activeSessions.forEach(session => {
                const percent = ((session.totalTokens / session.contextTokens) * 100).toFixed(1);
                const tokensK = Math.floor(session.totalTokens / 1000);
                
                // Get color based on percentage
                let colorClass = 'green';
                if (percent >= 90) colorClass = 'red';
                else if (percent >= 75) colorClass = 'red-orange';
                else if (percent >= 50) colorClass = 'orange';
                else if (percent >= 25) colorClass = 'yellow';
                
                // Format session name (better fallbacks)
                let name = session.label || '';
                
                if (!name) {
                    // Parse session key intelligently
                    const keyParts = session.key.split(':');
                    
                    // Check if it's a subagent (has "subagent" in key)
                    const subagentIndex = keyParts.indexOf('subagent');
                    if (subagentIndex >= 0 && keyParts.length > subagentIndex + 1) {
                        name = keyParts[subagentIndex + 1]; // Take name after "subagent"
                    } else if (keyParts.includes('main')) {
                        name = 'Main Session';
                    } else {
                        // Fallback: Take last meaningful part (not UUIDs)
                        const lastPart = keyParts[keyParts.length - 1];
                        if (lastPart.length > 20 && lastPart.includes('-')) {
                            // Looks like UUID, use channel + "Chat" instead
                            name = (session.channel || 'Unknown') + ' Chat';
                        } else {
                            name = lastPart;
                        }
                    }
                }
                
                // Capitalize first letter
                name = name.charAt(0).toUpperCase() + name.slice(1);
                
                // Channel name mapping (all supported Clawdbot channels)
                const channelNames = {
                    telegram: 'Telegram',
                    whatsapp: 'WhatsApp',
                    signal: 'Signal',
                    imessage: 'iMessage',
                    webchat: 'Web-Chat',
                    slack: 'Slack',
                    discord: 'Discord',
                    googlechat: 'Google Chat',
                    messenger: 'Messenger',
                    sms: 'SMS'
                };
                
                // Add differentiator for duplicates (with channel info for clarity)
                if (nameCount[name] > 1) {
                    nameIndex[name]++;
                    // Add channel info to help distinguish
                    const channelLabel = channelNames[session.channel] || 
                                        (session.channel ? session.channel.charAt(0).toUpperCase() + session.channel.slice(1) : '');
                    name = `${name} (${channelLabel})`;
                } else if (nameCount[name] === 1 && name === 'Main Session') {
                    // Even single main sessions: show channel for clarity
                    const channelLabel = channelNames[session.channel] || 
                                        (session.channel ? session.channel.charAt(0).toUpperCase() + session.channel.slice(1) : '');
                    if (channelLabel) {
                        name = `${name} (${channelLabel})`;
                    }
                }
                
                // Truncate if too long
                if (name.length > 30) name = name.substring(0, 27) + '...';
                
                // Channel icon (all supported Clawdbot channels)
                const channelIcons = {
                    telegram: '‚úàÔ∏è',
                    whatsapp: 'üíö',
                    signal: 'üîµ',
                    imessage: 'üí¨',
                    webchat: 'üåê',
                    slack: 'üíº',
                    discord: 'üéÆ',
                    googlechat: 'üî∑',
                    messenger: 'üíô',
                    sms: 'üì±'
                };
                const icon = channelIcons[session.channel] || 'üí¨';
                
                // Time ago
                const updatedAgo = formatTimeAgo(session.updatedAt);
                
                const item = document.createElement('div');
                item.className = 'session-item';
                item.onclick = () => switchToSession(session.key);
                
                item.innerHTML = `
                    <div class="session-header">
                        <div class="session-name">
                            <span>${icon}</span>
                            <span>${name}</span>
                        </div>
                        <div class="session-percent">${percent}%</div>
                    </div>
                    <div class="session-progress">
                        <div class="session-progress-fill ${colorClass}" style="width: ${percent}%"></div>
                    </div>
                    <div class="session-meta">
                        <span>${tokensK}k tokens</span>
                        <span>${updatedAgo}</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'just now';
        }
        
        function switchToSession(sessionKey) {
            // TODO: Implement session switching
            showNotification(`Session wechseln zu: ${sessionKey}`, 'info');
        }
        
        async function updateMultiSessions() {
            const sessions = await fetchSessions();
            if (sessions) {
                renderSessions(sessions);
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            updateFromGateway();
            updateMultiSessions();
        }, REFRESH_INTERVAL);
        
        // Initial load
        updateFromGateway();
        updateMultiSessions();

        function updateDashboard(percent, timeLeft = null, weeklyPercent = null) {
            const used = Math.floor((percent / 100) * 200000);
            const remaining = 200000 - used;
            const remainingK = Math.floor(remaining / 1000);
            
            const progressFill = document.getElementById('progressFill');
            const progressBar = document.getElementById('progressBar');
            const statusEmoji = document.getElementById('statusEmoji');
            const statusBadge = document.getElementById('statusBadge');
            const remainingLabel = document.getElementById('remainingLabel');
            
            // Update 5h bar
            setTimeout(() => {
                progressFill.style.width = percent + '%';
                progressBar.setAttribute('data-percent', percent.toFixed(1) + '%');
            }, 100);
            
            document.getElementById('usedTokens').textContent = used.toLocaleString() + ' tokens used';
            document.getElementById('remainingTokens').textContent = '~' + remainingK + 'k';
            
            // Calculate cost (Claude Sonnet 4.5 pricing)
            const cost = calculateCost(used);
            const maxCost = calculateCost(200000);
            document.getElementById('costEstimate').textContent = 'Cost: $' + cost.toFixed(3);
            document.getElementById('costLimit').textContent = '/ ~$' + maxCost.toFixed(2);
            
            // Update weekly bar
            if (weeklyPercent !== null) {
                const weeklyUsed = Math.floor((weeklyPercent / 100) * 1000000); // Assume ~1M weekly
                const weeklyUsedK = Math.floor(weeklyUsed / 1000);
                
                const progressFillWeekly = document.getElementById('progressFillWeekly');
                const progressBarWeekly = document.getElementById('progressBarWeekly');
                
                setTimeout(() => {
                    progressFillWeekly.style.width = weeklyPercent + '%';
                    progressBarWeekly.setAttribute('data-percent', weeklyPercent.toFixed(1) + '%');
                    
                    // Color weekly bar same as 5h bar
                    let colorClass = 'green';
                    if (weeklyPercent >= 90) colorClass = 'red';
                    else if (weeklyPercent >= 75) colorClass = 'red-orange';
                    else if (weeklyPercent >= 50) colorClass = 'orange';
                    else if (weeklyPercent >= 25) colorClass = 'yellow';
                    
                    progressFillWeekly.className = 'progress-fill ' + colorClass;
                }, 100);
                
                document.getElementById('usedTokensWeekly').textContent = weeklyUsedK + 'k tokens used';
                
                // Calculate weekly cost
                const weeklyCost = calculateCost(weeklyUsed);
                const weeklyMaxCost = calculateCost(1000000);
                document.getElementById('costEstimateWeekly').textContent = 'Cost: $' + weeklyCost.toFixed(2);
                document.getElementById('costLimitWeekly').textContent = '/ ~$' + weeklyMaxCost.toFixed(2);
            }
            
            // Update label with dynamic time
            if (timeLeft && remainingLabel) {
                // Format time nicely: "4h14m" ‚Üí "4h 14m" or just show as is
                const formattedTime = timeLeft.replace(/(\d+)([hm])/g, '$1$2 ').trim();
                remainingLabel.textContent = `‚è± ${formattedTime} left`;
            }
            
            // Take the worse status from BOTH 5h and weekly limits
            const worsePercent = Math.max(percent, weeklyPercent || 0);
            let limitInfo = '';
            
            // Show which limit is critical
            if (weeklyPercent !== null && weeklyPercent > percent) {
                limitInfo = ' (Weekly Limit!)';
            } else if (weeklyPercent !== null && percent > weeklyPercent) {
                limitInfo = ' (5h Limit!)';
            }
            
            let level, emoji, colorClass, statusText, sessions, recommendation;
            
            if (worsePercent >= 95) {
                level = 'emergency';
                emoji = 'üö®';
                colorClass = 'magenta';
                statusText = 'EMERGENCY' + limitInfo;
                sessions = 'NONE';
                recommendation = {
                    type: 'danger',
                    title: 'üÜò FINAL WARNING',
                    items: [
                        'Every message = risk!',
                        'Context will be cut soon!',
                        'START NEW SESSION NOW!!!'
                    ]
                };
            } else if (worsePercent >= 90) {
                level = 'critical';
                emoji = 'üî¥';
                colorClass = 'red';
                statusText = 'CRITICAL' + limitInfo;
                sessions = 'NONE';
                recommendation = {
                    type: 'warning',
                    title: 'üî• ACT NOW',
                    items: [
                        'Save memory (NOW!)',
                        'Summarize session',
                        'START NEW SESSION!'
                    ]
                };
            } else if (worsePercent >= 75) {
                level = 'high';
                emoji = 'üî∂';
                colorClass = 'red-orange';
                statusText = 'High Warning' + limitInfo;
                sessions = '<1 left';
                recommendation = {
                    type: 'warning',
                    title: 'üîß Recommendation',
                    items: [
                        'Make important decisions now',
                        'Prepare new session',
                        'Work token-efficiently'
                    ]
                };
            } else if (worsePercent >= 50) {
                level = 'medium';
                emoji = 'üü†';
                colorClass = 'orange';
                statusText = 'Medium Warning' + limitInfo;
                sessions = '~1 left';
                recommendation = {
                    type: '',
                    title: 'üîß Recommendation',
                    items: [
                        'Work token-efficiently',
                        'Prefer shorter responses'
                    ]
                };
            } else if (worsePercent >= 25) {
                level = 'low';
                emoji = 'üü°';
                colorClass = 'yellow';
                statusText = 'Low Warning' + limitInfo;
                sessions = '~2 left';
                recommendation = null;
            } else {
                level = 'ok';
                emoji = 'üü¢';
                colorClass = 'green';
                statusText = 'All good!';
                sessions = '~3-4 left';
                recommendation = null;
            }
            
            statusEmoji.textContent = emoji;
            progressFill.className = 'progress-fill ' + colorClass;
            statusBadge.className = 'status-badge ' + level;
            statusBadge.textContent = statusText;
            document.getElementById('sessionEstimate').textContent = sessions;
            
            const recBox = document.getElementById('recommendationBox');
            if (recommendation) {
                recBox.innerHTML = `
                    <div class="recommendation ${recommendation.type}">
                        <div class="recommendation-title">${recommendation.title}</div>
                        <ul class="recommendation-list">
                            ${recommendation.items.map(item => '<li>' + item + '</li>').join('')}
                        </ul>
                    </div>
                `;
            } else {
                recBox.innerHTML = '';
            }
            
            // Auto-Export bei 90% (nur einmal pro Session)
            checkAutoExport(worsePercent);
            
            // Update prediction
            updatePrediction();
        }
        
        // ==========================================
        // COST TRACKING
        // ==========================================
        
        function calculateCost(tokens) {
            // Claude Sonnet 4.5 pricing (as of 2025)
            // Input: $3.00 / 1M tokens
            // Output: $15.00 / 1M tokens
            
            // Assume typical conversation ratio: 75% input, 25% output
            const inputRatio = 0.75;
            const outputRatio = 0.25;
            
            const inputTokens = tokens * inputRatio;
            const outputTokens = tokens * outputRatio;
            
            const inputCost = (inputTokens / 1000000) * 3.00;
            const outputCost = (outputTokens / 1000000) * 15.00;
            
            return inputCost + outputCost;
        }
        
        // ==========================================
        // TOKEN PREDICTION ML
        // ==========================================
        
        function updatePrediction() {
            const history = loadHistory();
            const predictionEl = document.getElementById('predictionTime');
            
            if (!predictionEl) return;
            
            // Need at least 5 data points for reliable prediction
            if (history.session5h.length < 5) {
                predictionEl.textContent = 'Not enough data';
                predictionEl.style.fontSize = '11px';
                return;
            }
            
            // Use last 10 data points (max)
            const recentData = history.session5h.slice(-10);
            
            // Simple linear regression: y = mx + b
            const n = recentData.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            
            recentData.forEach((point, i) => {
                const x = i; // Time index
                const y = point.value; // Usage percent
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Check if usage is increasing (positive slope)
            if (slope <= 0.01) {
                predictionEl.textContent = 'Stable';
                predictionEl.style.fontSize = '14px';
                return;
            }
            
            // Predict when usage will reach 100%
            const currentUsage = recentData[recentData.length - 1].value;
            const remainingPercent = 100 - currentUsage;
            
            // Time between data points (in ms)
            const timeSpan = recentData[recentData.length - 1].timestamp - recentData[0].timestamp;
            const timePerPoint = timeSpan / (n - 1);
            
            // Extrapolate: How many more intervals until 100%?
            const intervalsToLimit = remainingPercent / slope;
            const msToLimit = intervalsToLimit * timePerPoint;
            
            // Safety check: Only show prediction if it's reasonable (< 24h)
            if (msToLimit < 0 || msToLimit > 24 * 60 * 60 * 1000) {
                predictionEl.textContent = '>24h';
                predictionEl.style.fontSize = '14px';
                return;
            }
            
            // Format time
            const minutes = Math.floor(msToLimit / (60 * 1000));
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            let timeText;
            if (hours > 0) {
                timeText = `~${hours}h ${mins}m`;
            } else {
                timeText = `~${mins}m`;
            }
            
            predictionEl.textContent = timeText;
            predictionEl.style.fontSize = '14px';
            
            // Color based on urgency
            if (hours < 1) {
                predictionEl.style.color = '#D85050'; // Red
            } else if (hours < 2) {
                predictionEl.style.color = '#D89050'; // Orange
            } else {
                predictionEl.style.color = 'var(--text-primary)';
            }
        }
        
        // ==========================================
        // AUTO-EXPORT SYSTEM
        // ==========================================
        
        let autoExportTriggered = false;
        
        function checkAutoExport(percent) {
            if (percent >= 90 && !autoExportTriggered) {
                autoExportTriggered = true;
                
                showNotification('üíæ Auto-Export: Session wird gesichert...', 'info');
                
                // Trigger export after 2 seconds (give user time to see notification)
                setTimeout(async () => {
                    await exportMemory();
                    
                    // Also trigger summary
                    showNotification('üìù Auto-Summary wird erstellt...', 'info');
                    setTimeout(() => {
                        summarize();
                    }, 2000);
                }, 2000);
            }
            
            // Reset flag if usage drops below 85% (after reset)
            if (percent < 85) {
                autoExportTriggered = false;
            }
        }
        
        // ==========================================
        // QUICK ACTIONS
        // ==========================================
        
        function newSession() {
            // Open new webchat session in new tab
            const webchatUrl = 'http://localhost:18789/chat?session=new';
            window.open(webchatUrl, '_blank');
            
            // Show success message
            showNotification('‚úÖ New session opened!', 'success');
        }
        
        async function summarize() {
            showNotification('üìù Creating summary...', 'info');
            
            // Mock action for testing (until CORS is fixed)
            if (USE_MOCK_DATA) {
                setTimeout(() => {
                    showNotification('‚úÖ Summary requested! (Mock)', 'success');
                }, 1000);
                return;
            }
            
            try {
                const response = await fetch(`${GATEWAY_URL}/tools/invoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GATEWAY_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tool: 'sessions_send',
                        args: {
                            message: 'Erstelle eine kompakte Zusammenfassung dieser Session mit den wichtigsten Entscheidungen, offenen Tasks und n√§chsten Schritten. Speichere sie dann in memory/.'
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Summary response:', result);
                    showNotification('‚úÖ Summary requested!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Summary failed:', response.status, errorText);
                    showNotification(`‚ùå Error ${response.status}`, 'error');
                }
                
            } catch (error) {
                console.error('Summarize error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function exportMemory() {
            showNotification('üì¶ Exporting session...', 'info');
            
            // Mock action for testing (until CORS is fixed)
            if (USE_MOCK_DATA) {
                const markdown = `# Session Export (MOCK DATA)\n\n**Date:** ${new Date().toLocaleString('de-DE')}\n\n---\n\n## üë§ User\n\nTest message 1\n\n---\n\n## ü§ñ Assistant\n\nTest response 1\n\n---\n\n## üë§ User\n\nTest message 2\n\n---\n\n## ü§ñ Assistant\n\nTest response 2\n`;
                
                const blob = new Blob([markdown], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session-export-mock-${Date.now()}.md`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('‚úÖ Session exported! (Mock)', 'success');
                return;
            }
            
            try {
                const response = await fetch(`${GATEWAY_URL}/tools/invoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GATEWAY_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tool: 'sessions_history',
                        args: {
                            sessionKey: 'agent:main:main',
                            limit: 1000
                        }
                    })
                });
                
                if (!response.ok) {
                    showNotification('‚ùå Export failed', 'error');
                    return;
                }
                
                const data = await response.json();
                const messages = data.result?.messages || [];
                
                // Convert to markdown
                let markdown = `# Session Export\n\n**Date:** ${new Date().toLocaleString('de-DE')}\n\n---\n\n`;
                
                messages.forEach((msg, i) => {
                    const role = msg.role === 'user' ? 'üë§ User' : 'ü§ñ Assistant';
                    const content = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);
                    markdown += `## ${role}\n\n${content}\n\n---\n\n`;
                });
                
                // Download as file
                const blob = new Blob([markdown], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session-export-${Date.now()}.md`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('‚úÖ Session exported!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('‚ùå Export failed', 'error');
            }
        }
        
        // Notification helper
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ==========================================
        // CONFIG UI
        // ==========================================
        
        let soundEnabled = true;
        let notificationsEnabled = true;
        let visualAlertsEnabled = true;
        let soundVolume = 0.2; // Default 20% volume (safe)
        let lastVisualAlertLevel = 0; // Track to avoid duplicate alerts
        
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            loadSettings();
            renderResetHistory();
            // Update slider fill after DOM is ready
            setTimeout(() => updateVolumeDisplay(), 50);
        }
        
        function renderResetHistory() {
            const container = document.getElementById('resetHistory');
            const resets = getRecentResets(24); // Last 24h
            
            if (resets.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px;">No resets in the last 24 hours</p>';
                return;
            }
            
            let html = '';
            resets.reverse().forEach(reset => {
                const time = new Date(reset.timestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const icon = reset.type === '5h' ? '‚è±Ô∏è' : 'üìÖ';
                const label = reset.type === '5h' ? '5-Hour' : 'Weekly';
                
                html += `
                    <div style="background: var(--progress-bg); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${icon} ${label} Reset</span>
                            <span style="font-size: 11px; color: var(--text-secondary);">${time}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${reset.before.toFixed(1)}% ‚Üí ${reset.after.toFixed(1)}%
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function saveAndClose() {
            const btn = document.getElementById('saveSettingsBtn');
            
            // Save all settings
            saveConfig();
            
            // Visual feedback
            btn.innerHTML = '‚úÖ Saved!';
            btn.style.background = '#10b981';
            
            // Close after short delay
            setTimeout(() => {
                closeSettings();
                // Reset button
                btn.innerHTML = 'üíæ Save & Close';
                btn.style.background = 'linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end))';
            }, 800);
        }
        
        function loadSettings() {
            const config = JSON.parse(localStorage.getItem('tokenAlertConfig') || '{}');
            
            soundEnabled = config.soundEnabled !== false;
            notificationsEnabled = config.notificationsEnabled !== false;
            visualAlertsEnabled = config.visualAlertsEnabled !== false;
            soundVolume = config.soundVolume !== undefined ? config.soundVolume : 0.2;
            
            // Only update DOM if elements exist (Settings modal is open)
            const soundEl = document.getElementById('soundEnabled');
            const notifEl = document.getElementById('notificationsEnabled');
            const visualEl = document.getElementById('visualAlertsEnabled');
            const volumeEl = document.getElementById('soundVolume');
            const intervalEl = document.getElementById('refreshInterval');
            const tokenEl = document.getElementById('gatewayToken');
            
            if (soundEl) soundEl.checked = soundEnabled;
            if (notifEl) notifEl.checked = notificationsEnabled;
            if (visualEl) visualEl.checked = visualAlertsEnabled;
            if (volumeEl) {
                volumeEl.value = Math.round(soundVolume * 100);
                updateVolumeDisplay();
            }
            if (intervalEl) intervalEl.value = config.refreshInterval || REFRESH_INTERVAL;
            if (tokenEl && config.gatewayToken) tokenEl.value = config.gatewayToken;
        }
        
        function saveSoundSetting() {
            soundEnabled = document.getElementById('soundEnabled').checked;
            saveConfig();
            showNotification(soundEnabled ? 'üîä Sound enabled' : 'üîá Sound disabled', 'success');
        }
        
        function updateVolumeDisplay() {
            const slider = document.getElementById('soundVolume');
            const display = document.getElementById('volumeDisplay');
            if (slider && display) {
                display.textContent = slider.value + '%';
                
                // Update slider fill effect - filled from RIGHT to LEFT (inverse)
                const percent = slider.value;
                const gradientStart = 'var(--bg-gradient-start)';
                const gradientEnd = 'var(--bg-gradient-end)';
                const bgColor = 'var(--progress-bg)';
                
                // Invert: empty on left, filled on right
                slider.style.background = `linear-gradient(to right, ${bgColor} 0%, ${bgColor} ${percent}%, ${gradientStart} ${percent}%, ${gradientEnd} 100%)`;
            }
        }
        
        function saveSoundVolume() {
            const slider = document.getElementById('soundVolume');
            soundVolume = parseInt(slider.value) / 100; // Convert to 0.0-1.0
            saveConfig();
            updateVolumeDisplay();
            showNotification(`üîä Volume set to ${slider.value}%`, 'success');
        }
        
        function testSound() {
            console.log('Test button clicked - soundEnabled:', soundEnabled, 'soundVolume:', soundVolume);
            
            // Play test sound even if checkbox is off (for testing purposes)
            const wasDisabled = !soundEnabled;
            if (wasDisabled) {
                soundEnabled = true; // Temporarily enable
            }
            
            playAlertSound('warning');
            
            if (wasDisabled) {
                soundEnabled = false; // Restore
                showNotification('üîä Test played (sound is disabled)', 'info');
            } else {
                showNotification('üîä Test sound played', 'info');
            }
        }
        
        function saveNotificationSetting() {
            notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            saveConfig();
            
            if (notificationsEnabled && 'Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            showNotification(notificationsEnabled ? 'üîî Notifications enabled' : 'üîï Notifications disabled', 'success');
        }
        
        function saveVisualAlertsSetting() {
            visualAlertsEnabled = document.getElementById('visualAlertsEnabled').checked;
            saveConfig();
            showNotification(visualAlertsEnabled ? 'üëÅÔ∏è Visual alerts enabled' : 'üëÅÔ∏è Visual alerts disabled', 'success');
        }
        
        function saveRefreshInterval() {
            const interval = parseInt(document.getElementById('refreshInterval').value);
            saveConfig();
            showNotification(`‚è±Ô∏è Refresh: ${interval/1000}s`, 'success');
            
            // TODO: Restart interval with new value
        }
        
        function saveGatewayToken() {
            saveConfig();
            showNotification('üîë Token saved', 'success');
        }
        
        function saveConfig() {
            const volumeSlider = document.getElementById('soundVolume');
            const config = {
                soundEnabled: document.getElementById('soundEnabled').checked,
                notificationsEnabled: document.getElementById('notificationsEnabled').checked,
                visualAlertsEnabled: document.getElementById('visualAlertsEnabled').checked,
                soundVolume: volumeSlider ? parseInt(volumeSlider.value) / 100 : soundVolume,
                refreshInterval: parseInt(document.getElementById('refreshInterval').value),
                gatewayToken: document.getElementById('gatewayToken').value
            };
            
            localStorage.setItem('tokenAlertConfig', JSON.stringify(config));
        }
        
        // Load config from localStorage on startup (settings values only, no DOM update yet)
        function initConfig() {
            const config = JSON.parse(localStorage.getItem('tokenAlertConfig') || '{}');
            soundEnabled = config.soundEnabled !== false;
            notificationsEnabled = config.notificationsEnabled !== false;
            visualAlertsEnabled = config.visualAlertsEnabled !== false;
            soundVolume = config.soundVolume !== undefined ? config.soundVolume : 0.2; // Default 20%
            
            // Load custom theme if exists
            loadCustomTheme();
        }
        
        // ==========================================
        // CUSTOM THEME SYSTEM
        // ==========================================
        
        function loadCustomTheme() {
            const customTheme = JSON.parse(localStorage.getItem('customTheme') || 'null');
            
            if (customTheme) {
                applyThemeColors(customTheme);
                
                // Update color pickers if settings modal is open
                const gradientStart = document.getElementById('customGradientStart');
                if (gradientStart) {
                    gradientStart.value = customTheme.gradientStart;
                    document.getElementById('customGradientEnd').value = customTheme.gradientEnd;
                    document.getElementById('customCardBg').value = customTheme.cardBg;
                    document.getElementById('customTextColor').value = customTheme.textColor;
                    updateThemePreview();
                }
            }
        }
        
        function applyThemeColors(theme) {
            const root = document.documentElement;
            
            // Apply to both light and dark mode
            root.style.setProperty('--bg-gradient-start', theme.gradientStart);
            root.style.setProperty('--bg-gradient-end', theme.gradientEnd);
            root.style.setProperty('--card-bg', theme.cardBg);
            root.style.setProperty('--text-primary', theme.textColor);
            
            // Derive secondary colors
            const brightness = getBrightness(theme.cardBg);
            const isLight = brightness > 128;
            
            if (isLight) {
                root.style.setProperty('--text-secondary', '#666666');
                root.style.setProperty('--border-color', '#e0e0e0');
                root.style.setProperty('--progress-bg', '#f0f0f0');
                root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.1)');
            } else {
                root.style.setProperty('--text-secondary', '#858585');
                root.style.setProperty('--border-color', '#3e3e42');
                root.style.setProperty('--progress-bg', '#3e3e42');
                root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.6)');
            }
        }
        
        function getBrightness(hexColor) {
            const rgb = hexToRgb(hexColor);
            return (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }
        
        function applyCustomTheme() {
            const theme = {
                gradientStart: document.getElementById('customGradientStart').value,
                gradientEnd: document.getElementById('customGradientEnd').value,
                cardBg: document.getElementById('customCardBg').value,
                textColor: document.getElementById('customTextColor').value
            };
            
            applyThemeColors(theme);
            updateThemePreview();
        }
        
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            if (!preview) return;
            
            const gradientStart = document.getElementById('customGradientStart').value;
            const gradientEnd = document.getElementById('customGradientEnd').value;
            
            preview.style.background = `linear-gradient(135deg, ${gradientStart}, ${gradientEnd})`;
        }
        
        function saveCustomTheme() {
            const theme = {
                gradientStart: document.getElementById('customGradientStart').value,
                gradientEnd: document.getElementById('customGradientEnd').value,
                cardBg: document.getElementById('customCardBg').value,
                textColor: document.getElementById('customTextColor').value
            };
            
            localStorage.setItem('customTheme', JSON.stringify(theme));
            applyThemeColors(theme);
            
            showNotification('‚úÖ Custom theme saved!', 'success');
            
            // Update chart colors if chart exists
            if (usageChart) {
                usageChart.destroy();
                initChart();
            }
        }
        
        function resetToDefaultTheme() {
            localStorage.removeItem('customTheme');
            
            // Reset to default light theme colors
            document.getElementById('customGradientStart').value = '#667eea';
            document.getElementById('customGradientEnd').value = '#764ba2';
            document.getElementById('customCardBg').value = '#ffffff';
            document.getElementById('customTextColor').value = '#1a1a1a';
            
            applyCustomTheme();
            showNotification('üîÑ Reset to default theme', 'success');
            
            // Update chart colors if chart exists
            if (usageChart) {
                usageChart.destroy();
                initChart();
            }
        }
        
        initConfig();
        
        // ==========================================
        // KEYBOARD SHORTCUTS
        // ==========================================
        
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            const key = e.key.toLowerCase();
            
            // R = Refresh stats
            if (key === 'r') {
                e.preventDefault();
                updateFromGateway();
                updateMultiSessions();
                showNotification('üîÑ Stats refreshed', 'success');
                
                // Visual feedback - pulse the dashboard
                const dashboard = document.querySelector('.dashboard');
                dashboard.style.animation = 'none';
                setTimeout(() => {
                    dashboard.style.animation = 'slideIn 0.3s ease-out';
                }, 10);
            }
            
            // N = New Chat
            else if (key === 'n') {
                e.preventDefault();
                newSession();
            }
            
            // S = Settings
            else if (key === 's') {
                e.preventDefault();
                openSettings();
            }
            
            // E = Export
            else if (key === 'e') {
                e.preventDefault();
                exportMemory();
            }
            
            // M = Summary
            else if (key === 'm') {
                e.preventDefault();
                summarize();
            }
            
            // ESC = Close settings
            else if (key === 'escape') {
                const modal = document.getElementById('settingsModal');
                if (modal && modal.style.display === 'flex') {
                    closeSettings();
                }
            }
            
            // ? = Show keyboard shortcuts help
            else if (key === '?' && e.shiftKey) {
                e.preventDefault();
                showKeyboardHelp();
            }
        });
        
        function showKeyboardHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.2s ease-out;
            `;
            
            helpModal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%;">
                    <h2 style="margin: 0 0 16px 0; font-size: 18px; color: var(--text-primary);">
                        ‚å®Ô∏è Keyboard Shortcuts
                    </h2>
                    <div style="display: grid; gap: 8px;">
                        ${[
                            { key: 'R', desc: 'Refresh stats' },
                            { key: 'N', desc: 'New chat session' },
                            { key: 'S', desc: 'Open settings' },
                            { key: 'E', desc: 'Export memory' },
                            { key: 'M', desc: 'Create summary' },
                            { key: 'ESC', desc: 'Close settings' },
                            { key: '?', desc: 'Show this help' }
                        ].map(({ key, desc }) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--progress-bg); border-radius: 8px;">
                                <span style="font-weight: 600; color: var(--text-primary); font-family: monospace;">${key}</span>
                                <span style="color: var(--text-secondary); font-size: 13px;">${desc}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="width: 100%; margin-top: 16px; padding: 10px; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Got it!
                    </button>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Click outside to close
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }
        
        // Show keyboard hint on first visit
        if (!localStorage.getItem('keyboardHintShown')) {
            setTimeout(() => {
                const hint = document.createElement('div');
                hint.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                    color: white;
                    padding: 12px 16px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 9999;
                    font-size: 13px;
                    animation: slideUp 0.3s ease-out;
                    cursor: pointer;
                `;
                hint.innerHTML = 'üí° Press <b>?</b> for keyboard shortcuts';
                hint.onclick = () => hint.remove();
                
                document.body.appendChild(hint);
                
                setTimeout(() => hint.remove(), 5000);
                localStorage.setItem('keyboardHintShown', 'true');
            }, 2000);
        }
        
        // ==========================================
        // PWA INITIALIZATION
        // ==========================================
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ PWA: Service Worker registered:', registration.scope);
                        
                        // Check for updates every 5 minutes
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);
                    })
                    .catch(error => {
                        console.warn('‚ùå PWA: Service Worker registration failed:', error);
                    });
            });
        }
        
        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button (if we want a custom UI)
            console.log('üí° PWA: Install prompt available');
            
            // Auto-show install prompt after 3 seconds (optional)
            setTimeout(() => {
                if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                    showInstallPrompt();
                }
            }, 3000);
        });
        
        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 16px;
                max-width: 90%;
                animation: slideUp 0.3s ease-out;
            `;
            
            installBanner.innerHTML = `
                <span style="font-size: 14px; font-weight: 600;">üì± Install Token Alert as App?</span>
                <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); border: none; border-radius: 8px; padding: 8px 16px; color: white; font-weight: 600; cursor: pointer;">
                    Install
                </button>
                <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; padding: 4px 8px;">
                    √ó
                </button>
            `;
            
            document.body.appendChild(installBanner);
        }
        
        window.installPWA = async function() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            console.log('PWA install outcome:', outcome);
            
            if (outcome === 'accepted') {
                showNotification('‚úÖ App installed successfully!', 'success');
            }
            
            deferredPrompt = null;
            document.querySelectorAll('[onclick*="installPWA"]').forEach(el => {
                if (el.parentElement) el.parentElement.remove();
            });
        };
        
        // Detect if running as installed PWA
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone || 
                      document.referrer.includes('android-app://');
        
        if (isPWA) {
            console.log('‚úÖ Running as installed PWA');
            document.body.classList.add('pwa-mode');
        }
        
        // Handle URL actions (from shortcuts)
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        
        if (action === 'refresh') {
            updateFromGateway();
            showNotification('üîÑ Stats refreshed', 'success');
        } else if (action === 'export') {
            exportMemory();
        }
        
        // Initialize (updateFromGateway() is called automatically above)
    </script>
    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--card-bg); border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px; color: var(--text-primary);">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    üîä Sound Alerts
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                    <input type="checkbox" id="soundEnabled" checked onchange="saveSoundSetting()">
                    <span style="color: var(--text-secondary); font-size: 13px;">Enable sound notifications at 75%, 90%, 95%</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="color: var(--text-secondary); font-size: 13px; min-width: 60px;">Volume:</span>
                    <input type="range" id="soundVolume" min="0" max="100" value="20" 
                           onchange="saveSoundVolume()" oninput="updateVolumeDisplay()"
                           style="flex: 1;">
                    <span id="volumeDisplay" style="color: var(--text-primary); font-size: 13px; font-weight: 600; min-width: 40px; text-align: right;">20%</span>
                    <button onclick="testSound()" style="background: var(--progress-bg); border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; color: var(--text-primary); font-size: 12px;">
                        üîä Test
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    üîî Browser Notifications
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="notificationsEnabled" checked onchange="saveNotificationSetting()">
                    <span style="color: var(--text-secondary); font-size: 13px;">Enable desktop notifications</span>
                </label>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    üëÅÔ∏è Visual On-Screen Alerts
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="visualAlertsEnabled" checked onchange="saveVisualAlertsSetting()">
                    <span style="color: var(--text-secondary); font-size: 13px;">Show visual alerts at 25%, 50%, 75%, 90%, 95%</span>
                </label>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    ‚è±Ô∏è Refresh Interval
                </label>
                <select id="refreshInterval" onchange="saveRefreshInterval()" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary);">
                    <option value="10000">10 seconds</option>
                    <option value="30000" selected>30 seconds</option>
                    <option value="60000">60 seconds</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">
                    üîë Gateway Token
                </label>
                <input type="password" id="gatewayToken" value="d91a7a91e0d6bda8b6e3182467fda1f0bebd34c830263a4f" onchange="saveGatewayToken()" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                <small style="color: var(--text-secondary); font-size: 11px;">From ~/.clawdbot/clawdbot.json ‚Üí gateway.auth.token</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    üîÑ Reset History (Last 24h)
                </label>
                <div id="resetHistory"></div>
            </div>
            
            <!-- Custom Theme Editor -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                    üé® Custom Theme Colors
                </label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                            Gradient Start
                        </label>
                        <input type="color" id="customGradientStart" value="#667eea" 
                               onchange="applyCustomTheme()"
                               style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                            Gradient End
                        </label>
                        <input type="color" id="customGradientEnd" value="#764ba2" 
                               onchange="applyCustomTheme()"
                               style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                            Card Background
                        </label>
                        <input type="color" id="customCardBg" value="#ffffff" 
                               onchange="applyCustomTheme()"
                               style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                            Text Color
                        </label>
                        <input type="color" id="customTextColor" value="#1a1a1a" 
                               onchange="applyCustomTheme()"
                               style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button onclick="saveCustomTheme()" 
                            style="flex: 1; padding: 8px; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">
                        üíæ Save Theme
                    </button>
                    <button onclick="resetToDefaultTheme()" 
                            style="flex: 1; padding: 8px; background: var(--progress-bg); color: var(--text-primary); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">
                        üîÑ Reset
                    </button>
                </div>
                <div id="themePreview" style="margin-top: 12px; padding: 16px; border-radius: 8px; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: white; text-align: center; font-weight: 600; font-size: 13px;">
                    Theme Preview
                </div>
            </div>
            
            <button id="saveSettingsBtn" onclick="saveAndClose()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                üíæ Save & Close
            </button>
        </div>
    </div>
</body>
</html>
